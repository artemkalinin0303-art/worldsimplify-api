<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>WorldSimplify ‚Äî –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, system-ui,
          sans-serif;
        background: #f5f5f8;
        color: #111827;
        font-size: 15px;
      }

      /* ---------- TOP NAV ---------- */

      .topbar {
        height: 56px;
        padding: 0 32px;
        background: #ffffff;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .top-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-mark {
        width: 26px;
        height: 26px;
        border-radius: 9px;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #f9fafb;
        font-weight: 700;
        font-size: 14px;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
      }

      .logo-text {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .logo-sub {
        font-size: 12px;
        color: #6b7280;
      }

      .top-right {
        font-size: 12px;
        color: #6b7280;
      }

      /* ---------- MAIN SHELL ---------- */

      .page {
        max-width: 1160px;
        margin: 0 auto;
        padding: 20px 24px 40px;
      }

      .title-row {
        margin-bottom: 14px;
      }

      .title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .subtitle {
        font-size: 13px;
        color: #6b7280;
      }

      /* ---------- WORKSPACE (2 –∫–æ–ª–æ–Ω–∫–∏) ---------- */

      .workspace {
        background: #ffffff;
        border-radius: 20px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 14px 30px rgba(15, 23, 42, 0.06);
        padding: 18px;
        display: grid;
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.15fr);
        column-gap: 18px;
        row-gap: 12px;
      }

      @media (max-width: 900px) {
        .workspace {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .column {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .small-label {
        font-size: 13px;
        color: #6b7280;
      }

      /* ---------- LEFT COLUMN: –≤–≤–æ–¥ ---------- */

      textarea {
        width: 100%;
        min-height: 220px;
        background: #f9fafb;
        color: #111827;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        padding: 12px;
        resize: vertical;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 14px;
        line-height: 1.45;
        outline: none;
      }

      textarea:focus {
        border-color: #60a5fa;
        box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.45);
      }

      .controls-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 12px;
      }

      button {
        cursor: pointer;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        color: #111827;
        font-size: 14px;
        padding: 8px 20px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background 0.15s, border-color 0.15s, box-shadow 0.15s,
          transform 0.1s, opacity 0.1s;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }

      button:hover:not([disabled]) {
        background: #f9fafb;
        border-color: #93c5fd;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        transform: translateY(-1px);
      }

      button[disabled] {
        opacity: 0.55;
        cursor: default;
        box-shadow: none;
      }

      .btn-primary {
        background: #60a5fa;
        border-color: #60a5fa;
        color: #f9fafb;
      }

      .btn-primary:hover:not([disabled]) {
        background: #4f8ff4;
        border-color: #4f8ff4;
        box-shadow: 0 6px 14px rgba(79, 143, 244, 0.45);
      }

      .btn-ghost {
        background: #ffffff;
        color: #1f2937;
      }

      .btn-mini {
        margin-top: 4px;
        padding: 4px 10px;
        font-size: 11px;
        border-radius: 999px;
        box-shadow: none;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
      .filter-btn.active {
          background: #e0edff;
          border-color: #60a5fa;
          font-weight: 600;
          color: #1d4ed8;
      }

      /* ---------- spinner / —Å—Ç–∞—Ç—É—Å ---------- */

      .status-row {
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 20px;
      }

      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid #dbeafe;
        border-top-color: #3b82f6;
        animation: spin 0.6s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ---------- RISK PILL —Å–ª–µ–≤–∞ ---------- */

      .risk-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        min-width: 110px;
        border: 1px solid transparent;
      }

      .risk-low {
        background: #ecfdf5;
        border-color: #bbf7d0;
        color: #15803d;
      }

      .risk-medium {
        background: #fffbeb;
        border-color: #fed7aa;
        color: #92400e;
      }

      .risk-high {
        background: #fff1f2;
        border-color: #fecaca;
        color: #b91c1c;
      }

      .risk-critical {
        background: #fdf4ff;
        border-color: #e9d5ff;
        color: #6b21a8;
      }

      /* ---------- Upload: dropzone ---------- */

      .upload-card {
        margin-top: 4px;
        background: #f9fafb;
        border-radius: 14px;
        border: 1px dashed #d1d5db;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        transition: border-color 0.15s, background 0.15s;
      }

      .upload-card.dragover {
        border-color: #60a5fa;
        background: #e0edff;
      }

      .upload-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      input[type="file"] {
        font-size: 12px;
      }

      .preview-box {
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        padding: 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 13px;
        white-space: pre-wrap;
        max-height: 120px;
        overflow: auto;
      }

      /* ---------- Highlighted text (–û—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) ---------- */

      .highlight-box {
        background: #ffffff;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        padding: 8px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 13px;
        white-space: normal;
        min-height: 180px; 
        overflow: auto;
        scroll-behavior: smooth;
        position: relative;
      }
      
      .hl-high {
        background: #fee2e2;
        border-radius: 3px;
        padding: 0 2px;
        scroll-margin-top: 10px;
        transition: outline 0.1s ease-in-out;
      }

      /* ---------- RIGHT COLUMN: –æ—Ç—á—ë—Ç ---------- */

      .result-layout {
        display: grid;
        grid-template-columns: minmax(0, 1.15fr) minmax(0, 1.2fr);
        gap: 10px;
      }

      @media (max-width: 900px) {
        .result-layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .result-card {
        background: #f9fafb;
        border-radius: 14px;
        border: 1px solid #e5e7eb;
        padding: 10px 12px 10px;
        font-size: 13px;
      }

      .result-card.full {
        grid-column: 1 / -1;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
        padding-bottom: 4px;
      }

      .card-title {
        font-size: 12px;
        font-weight: 600;
        color: #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }

      .card-toggle {
        font-size: 11px;
        color: #9ca3af;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .card-body {
        margin-top: 6px;
      }

      .card-collapsed .card-body {
        display: none;
      }

      /* ---------- Hero risk card —Å –±–æ–ª—å—à–∏–º –∫—Ä—É–≥–æ–º ---------- */

      .hero-risk {
        display: flex;
        gap: 16px;
        align-items: center;
      }

      .hero-circle-wrap {
        width: 112px;
        height: 112px;
        position: relative;
      }

      .hero-circle-text {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 22px;
      }

      .hero-info-main {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .hero-info-sub {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.55;
      }

      .scale-text {
        margin-top: 8px;
        font-size: 11px;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .scale-text span {
        font-weight: 500;
      }

      .verdict {
        margin-top: 8px;
        font-size: 13px;
        font-weight: 600;
      }

      .verdict-low {
        color: #15803d;
      }

      .verdict-medium {
        color: #92400e;
      }

      .verdict-high {
        color: #b91c1c;
      }

      /* ---------- risk distribution (–ù–û–í–ê–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø) ---------- */

      .risk-distribution {
        margin-top: 8px;
        font-size: 11px;
        color: #4b5563;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .dist-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .dist-label {
        width: 60px;
        font-weight: 500;
      }

      .dist-bar-wrap {
        flex: 1;
        height: 6px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
      }

      .dist-bar {
        height: 100%;
        transition: width 0.3s ease-out;
        border-radius: 999px;
      }

      .dist-count {
        width: 20px;
        text-align: right;
        font-weight: 600;
        color: #1f2937;
      }

      /* –¶–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª–æ—Å–æ–∫ */
      .dist-high .dist-bar {
        background: #f87171;
      }
      .dist-medium .dist-bar {
        background: #facc15;
      }
      .dist-low .dist-bar {
        background: #4ade80;
      }
      
      /* ---------- Top 3 Risks ---------- */

      .top-risks-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .top-risk-card {
        flex: 1 1 30%;
        min-width: 180px;
        background: #fff1f2;
        border-radius: 12px;
        border: 1px solid #fecaca;
        padding: 8px 9px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .top-risk-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        font-weight: 600;
        font-size: 13px;
        color: #b91c1c;
      }

      .top-risk-title {
        font-size: 13px;
        font-weight: 500;
      }

      .top-risk-caption {
        font-size: 12px;
        color: #7f1d1d;
      }

      /* ---------- Lists + Diff Mode Styles ---------- */

      .risk-list,
      .recs-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .risk-item {
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 6px 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        position: relative; 
        transition: opacity 0.3s;
      }
      
      /* –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
      .risk-item.hidden {
        display: none !important;
      }

      /* –í–∏–∑—É–∞–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: —Ü–≤–µ—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–ª–µ–≤–∞ */
      .risk-item.high {
          border-left: 5px solid #f87171;
          padding-left: 10px;
          background: #fff1f2;
          border-color: #fecaca;
      }
      .risk-item.medium {
          border-left: 5px solid #facc15;
          padding-left: 10px;
          background: #fffbeb;
          border-color: #fed7aa;
      }
      .risk-item.low {
          border-left: 5px solid #4ade80;
          padding-left: 10px;
          background: #ecfdf5;
          border-color: #bbf7d0;
      }

      .risk-header-row {
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .risk-meta-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }

      .risk-badge,
      .rec-badge {
        font-size: 11px;
        font-weight: 600;
        border-radius: 999px;
        padding: 2px 8px;
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .badge-high {
        background: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
      }

      .badge-medium {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fed7aa;
      }

      .badge-low {
        background: #dcfce7;
        color: #15803d;
        border: 1px solid #bbf7d0;
      }

      .rec-badge {
        background: #dbeafe;
        border: 1px solid #bfdbfe;
        color: #1d4ed8;
      }

      .risk-text,
      .rec-text {
        font-size: 13px;
      }

      .risk-tags {
        font-size: 11px;
        color: #6b7280;
        display: inline-flex;
        gap: 4px;
        align-items: center;
        white-space: nowrap;
      }

      .risk-tags-icon {
        font-size: 13px;
      }

      /* DIFF MODE STYLES */
      .diff-container {
          margin-top: 8px;
          padding: 10px;
          border: 1px dashed #d1d5db;
          border-radius: 8px;
          background: #ffffff;
          font-size: 13px;
          line-height: 1.5;
          white-space: pre-wrap;
          font-family: "Inter", sans-serif;
          display: none; 
      }
      
      .diff-deleted {
          text-decoration: line-through;
          background-color: #fcebeb; 
          color: #b91c1c;
          padding: 1px 3px;
          border-radius: 3px;
      }

      .diff-added {
          background-color: #ecfdf5;
          color: #065f46;
          padding: 1px 3px;
          border-radius: 3px;
      }
      
      .diff-controls {
          display: flex;
          justify-content: flex-end;
          gap: 8px;
          margin-top: 8px;
      }

      /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ details */
      .risk-details {
        display: none; 
      }
      .risk-item.open .risk-details {
        display: none; 
      }
      
      /* ---------- Raw report (–£–î–ê–õ–ï–ù–û) ---------- */

    </style>
  </head>
  <body>
    <header class="topbar">
      <div class="top-left">
        <div class="logo-mark">W</div>
        <div>
          <div class="logo-text">WorldSimplify</div>
          <div class="logo-sub">–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å –ò–ò</div>
        </div>
      </div>
      <div class="top-right">v9.1 ¬∑ beta</div>
    </header>

    <main class="page">
      <div class="title-row">
        <div class="title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä–∞—Ö</div>
        <div class="subtitle">
          –í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª ‚Äî —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç —Ä–∏—Å–∫–∏ –∏ –æ–±—ä—è—Å–Ω–∏—Ç –∏—Ö
          –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.
        </div>
      </div>

      <section class="workspace">
        <div class="column">
          <div>
            <div class="small-label">–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</div>
            <textarea
              id="taInput"
              placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞..."
            ></textarea>
          </div>

          <div class="controls-row">
            <button id="btnAnalyze" class="btn-primary">üîç –ê–Ω–∞–ª–∏–∑ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ</button>
            <button id="exportBtn" class="btn-ghost">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç DOCX</button>
          </div>

          <div class="status-row">
            <div id="statusSpinner" class="spinner" style="display: none"></div>
            <div id="statusText" class="small-label"></div>
          </div>

          <div class="controls-row">
            <span class="small-label">–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞:</span>
            <div id="riskPill" class="risk-pill risk-low">Low (0/100)</div>
          </div>

          <div
            class="upload-card"
            id="uploadCard"
            title="–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞"
          >
            <div class="small-label">
              –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ (PDF / DOCX / —Ñ–æ—Ç–æ) ‚Äî –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä—É–∫–∞–º–∏
            </div>
            <div class="upload-row">
              <input type="file" id="fileInput" />
              <button id="uploadBtn">‚¨ÜÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
              <button id="analyzeFileBtn" disabled>‚ñ∂Ô∏è –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª</button>
            </div>
            <div class="small-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—Å—Ç–∞</div>
            <pre id="previewBox" class="preview-box">‚Äî</pre>
          </div>
          
          <div>
            <div class="small-label">–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—Å—Ç–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</div>
            <div id="highlightBox" class="highlight-box">
              –ó–¥–µ—Å—å –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∞–º—ã—Ö –æ–ø–∞—Å–Ω—ã—Ö
              —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.
            </div>
          </div>
        </div>

        <div class="column">
          <div class="small-label">–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
          <div class="result-layout">
            <div class="result-card" id="heroCard">
              <div class="card-header">
                <div class="card-title">–ò–Ω–¥–µ–∫—Å —Ä–∏—Å–∫–∞</div>
                <div class="card-toggle" data-target="heroBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="heroBody">
                <div class="hero-risk">
                  <div class="hero-circle-wrap">
                    <svg
                      id="heroSvg"
                      viewBox="0 0 100 100"
                      width="112"
                      height="112"
                    >
                      <circle
                        cx="50"
                        cy="50"
                        r="42"
                        stroke="#e5e7eb"
                        stroke-width="10"
                        fill="none"
                      ></circle>
                      <circle
                        id="heroCircle"
                        cx="50"
                        cy="50"
                        r="42"
                        stroke="#22c55e"
                        stroke-width="10"
                        fill="none"
                        stroke-linecap="round"
                        stroke-dasharray="264"
                        stroke-dashoffset="264"
                        transform="rotate(-90 50 50)"
                      ></circle>
                    </svg>
                    <div class="hero-circle-text" id="scoreValue">0</div>
                  </div>
                  <div>
                    <div class="hero-info-main" id="scoreLevelText">
                      –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                    </div>
                    <div class="hero-info-sub" id="scoreDesc">
                      –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ü–µ–Ω–∫—É —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–∞.
                    </div>
                  </div>
                </div>
                <div class="scale-text">
                  <span>‚ö†Ô∏è</span>
                  <span>0‚Äì30:</span> –±–µ–∑–æ–ø–∞—Å–Ω–æ ¬∑
                  <span>31‚Äì70:</span> —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ ¬∑
                  <span>71‚Äì100:</span> –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫
                </div>
                <div id="verdictText" class="verdict verdict-low">
                  –ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–∫–∏ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä–¥–∏–∫—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É.
                </div>
                <div class="risk-distribution">
                  <div class="dist-row dist-high">
                    <span class="dist-label">High:</span>
                    <div class="dist-bar-wrap">
                        <span id="distHighBar" class="dist-bar"></span>
                    </div>
                    <span id="distHighCount" class="dist-count">0</span>
                  </div>
                  <div class="dist-row dist-medium">
                    <span class="dist-label">Medium:</span>
                    <div class="dist-bar-wrap">
                        <span id="distMedBar" class="dist-bar"></span>
                    </div>
                    <span id="distMedCount" class="dist-count">0</span>
                  </div>
                  <div class="dist-row dist-low">
                    <span class="dist-label">Low:</span>
                    <div class="dist-bar-wrap">
                        <span id="distLowBar" class="dist-bar"></span>
                    </div>
                    <span id="distLowCount" class="dist-count">0</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="result-card" id="summaryCard">
              <div class="card-header">
                <div class="card-title">Summary</div>
                <div class="card-toggle" data-target="summaryBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="summaryBody">
                <div id="summaryText" class="small-label">
                  –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É.
                </div>
              </div>
            </div>

            <div class="result-card full" id="topCard">
              <div class="card-header">
                <div class="card-title">Top-3 —Å–∞–º—ã—Ö –∂—ë—Å—Ç–∫–∏—Ö —Ä–∏—Å–∫–∞</div>
                <div class="card-toggle" data-target="topBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="topBody">
                <div id="topRisksRow" class="top-risks-row"></div>
              </div>
            </div>

            <div class="result-card full" id="neuroCard">
              <div class="card-header">
                <div class="card-title">–ù–µ–π—Ä–æ—Å–æ–≤–µ—Ç</div>
                <div class="card-toggle" data-target="neuroBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="neuroBody">
                <div id="neuroAdviceText" class="small-label">
                  –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≥–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –ò–ò –æ —Ç–æ–º, —á—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é —É–≥—Ä–æ–∑—É
                  –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.
                </div>
              </div>
            </div>

            <div class="result-card full" id="risksCard">
              <div class="card-header">
                <div class="card-title">–ö–ª—é—á–µ–≤—ã–µ —Ä–∏—Å–∫–∏</div>
                <div class="card-toggle" data-target="risksBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="risksBody">
                <div class="filter-controls" style="margin-bottom: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                    <span class="small-label" style="margin-right: 4px;">–§–∏–ª—å—Ç—Ä:</span>
                    <button class="btn-mini filter-btn active" data-filter="all">–í—Å–µ (<span id="filterCountAll">0</span>)</button>
                    <button class="btn-mini filter-btn" data-filter="high">–í—ã—Å–æ–∫–∏–µ (<span id="filterCountHigh">0</span>)</button>
                    <button class="btn-mini filter-btn" data-filter="medium">–°—Ä–µ–¥–Ω–∏–µ (<span id="filterCountMedium">0</span>)</button>
                    <button class="btn-mini filter-btn" data-filter="low">–ù–∏–∑–∫–∏–µ (<span id="filterCountLow">0</span>)</button>
                    <input type="text" id="searchRisksInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–∏—Å–∫–∞–º..." style="flex-grow: 1; padding: 6px 10px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 13px; max-width: 200px;">
                </div>

                <ul id="risksList" class="risk-list"></ul>
              </div>
            </div>

            <div class="result-card full" id="recsCard">
              <div class="card-header">
                <div class="card-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                <div class="card-toggle" data-target="recsBody">
                  –°–≤–µ—Ä–Ω—É—Ç—å ‚åÑ
                </div>
              </div>
              <div class="card-body" id="recsBody">
                <ul id="recsList" class="recs-list"></ul>
              </div>
            </div>

            </div>
        </div>
      </section>
    </main>

    <script>
      const taInput = document.getElementById("taInput");
      const btnAnalyze = document.getElementById("btnAnalyze");
      const exportBtn = document.getElementById("exportBtn");
      const riskPill = document.getElementById("riskPill");

      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const analyzeFileBtn = document.getElementById("analyzeFileBtn");
      const previewBox = document.getElementById("previewBox");
      const highlightBox = document.getElementById("highlightBox");
      const uploadCard = document.getElementById("uploadCard");

      const statusSpinner = document.getElementById("statusSpinner");
      const statusText = document.getElementById("statusText");

      const heroCircle = document.getElementById("heroCircle");
      const scoreValueEl = document.getElementById("scoreValue");
      const scoreLevelTextEl = document.getElementById("scoreLevelText");
      const scoreDescEl = document.getElementById("scoreDesc");
      const verdictTextEl = document.getElementById("verdictText");

      const distHighBarEl = document.getElementById("distHighBar");
      const distMedBarEl = document.getElementById("distMedBar");
      const distLowBarEl = document.getElementById("distLowBar");
      const distHighCountEl = document.getElementById("distHighCount");
      const distMedCountEl = document.getElementById("distMedCount");
      const distLowCountEl = document.getElementById("distLowCount");
      
      // –≠–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      const filterCountAllEl = document.getElementById("filterCountAll");
      const filterCountHighEl = document.getElementById("filterCountHigh");
      const filterCountMediumEl = document.getElementById("filterCountMedium");
      const filterCountLowEl = document.getElementById("filterCountLow");
      const searchRisksInput = document.getElementById("searchRisksInput"); 

      const summaryTextEl = document.getElementById("summaryText");
      const risksListEl = document.getElementById("risksList");
      const recsListEl = document.getElementById("recsList");
      const topRisksRowEl = document.getElementById("topRisksRow");
      const neuroAdviceTextEl = document.getElementById("neuroAdviceText");

      let currentDocId = null;
      let lastContractText = "";
      let lastReportText = "";
      let riskCounter = 0; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID (—è–∫–æ—Ä–µ–π)
      let allRiskItems = []; // –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ —Ä–∏—Å–∫–æ–≤

      const CIRCUMFERENCE = 2 * Math.PI * 42;

      function setHeroCircle(score) {
        const clamped = Math.min(Math.max(score, 0), 100);
        const offset = CIRCUMFERENCE - (CIRCUMFERENCE * clamped) / 100;
        heroCircle.setAttribute("stroke-dasharray", CIRCUMFERENCE.toString());
        heroCircle.setAttribute("stroke-dashoffset", offset.toString());

        let color = "#22c55e";
        if (clamped > 70) color = "#f97373";
        else if (clamped > 30) color = "#fbbf24";
        heroCircle.setAttribute("stroke", color);
      }

      function parseScoreAndLevel(text) {
        const scoreMatch = text.match(/RISK_SCORE:\s*(\d+)\s*\/\s*100/i);
        const levelMatch = text.match(/RISK_LEVEL:\s*([A-Za-z–ê-–Ø–∞-—è]+)/i);

        let score = 0;
        let level = "Low";

        if (scoreMatch) {
          score = parseInt(scoreMatch[1] || "0", 10);
        }

        if (levelMatch) {
          level = levelMatch[1];
        } else {
          if (score <= 30) level = "Low";
          else if (score <= 70) level = "Medium";
          else level = "High";
        }
        return { score, level };
      }

      function levelText(level) {
        const l = level.toLowerCase();
        if (l.startsWith("high")) return "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞";
        if (l.startsWith("medium")) return "–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞";
        return "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞";
      }

      function levelDesc(level) {
        const l = level.toLowerCase();
        if (l.startsWith("high"))
          return "–î–æ–≥–æ–≤–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Ä—å—ë–∑–Ω—ã–µ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —É—Å–ª–æ–≤–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø—É–Ω–∫—Ç—ã.";
        if (l.startsWith("medium"))
          return "–ï—Å—Ç—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –Ω–æ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —Ä–∏—Å–∫–∏. –°—Ç–æ–∏—Ç –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–π—Ç–∏—Å—å –ø–æ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º.";
        return "–°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤ –ø–æ—á—Ç–∏ –Ω–µ—Ç, –Ω–æ –ø—Ä–∏ –∫—Ä—É–ø–Ω—ã—Ö —Å—É–º–º–∞—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç–æ–∏—Ç –¥–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä –Ω–∞ —é—Ä–ø—Ä–æ–≤–µ—Ä–∫—É.";
      }

      function verdictByScore(score) {
        if (score >= 71) {
          return {
            text: "–≠—Ç–æ—Ç –¥–æ–≥–æ–≤–æ—Ä –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å –Ω–µ–ª—å–∑—è üö´",
            css: "verdict-high",
          };
        }
        if (score >= 40) {
          return {
            text:
              "–î–æ–≥–æ–≤–æ—Ä —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π ‚ö†Ô∏è –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º.",
            css: "verdict-medium",
          };
        }
        return {
          text:
            "–î–æ–≥–æ–≤–æ—Ä –≤ —Ü–µ–ª–æ–º –±–µ–∑–æ–ø–∞—Å–µ–Ω üëç –º–æ–∂–Ω–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é –∏ –≤–Ω–∏–º–∞–Ω–∏–µ–º –∫ –¥–µ—Ç–∞–ª—è–º.",
          css: "verdict-low",
        };
      }

      function updateVerdict(score) {
        verdictTextEl.classList.remove(
          "verdict-low",
          "verdict-medium",
          "verdict-high"
        );
        const v = verdictByScore(score);
        verdictTextEl.textContent = v.text;
        verdictTextEl.classList.add(v.css);
      }

      function updateRiskPill(score, level) {
        riskPill.classList.remove(
          "risk-low",
          "risk-medium",
          "risk-high",
          "risk-critical"
        );

        let cssClass = "risk-low";
        if (level.toLowerCase().startsWith("medium")) cssClass = "risk-medium";
        else if (level.toLowerCase().startsWith("high")) cssClass = "risk-high";
        else if (level.toLowerCase().startsWith("crit")) cssClass = "risk-critical";

        riskPill.classList.add(cssClass);
        riskPill.textContent = `${level} (${score}/100)`;
      }

      // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∏—Å–∫–æ–≤ –ø–æ–ª–æ—Å–∫–∞–º–∏
      function updateRiskDistribution(highCount, medCount, lowCount) {
        const total = highCount + medCount + lowCount;
        
        const highPct = total > 0 ? (highCount / total) * 100 : 0;
        const medPct = total > 0 ? (medCount / total) * 100 : 0;
        const lowPct = total > 0 ? (lowCount / total) * 100 : 0;

        distHighBarEl.style.width = highPct + "%";
        distMedBarEl.style.width = medPct + "%";
        distLowBarEl.style.width = lowPct + "%";

        distHighCountEl.textContent = String(highCount);
        distMedCountEl.textContent = String(medCount);
        distLowCountEl.textContent = String(lowCount);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        filterCountAllEl.textContent = String(total);
        filterCountHighEl.textContent = String(highCount);
        filterCountMediumEl.textContent = String(medCount);
        filterCountLowEl.textContent = String(lowCount);
      }

      function parseReportSections(report) {
        const lines = report.split(/\r?\n/);

        let section = null;
        let summary = [];
        let risks = [];
        let recs = [];

        for (let rawLine of lines) {
          const line = rawLine.trim();

          if (/^SUMMARY:/i.test(line)) {
            section = "summary";
            continue;
          }
          if (/^RISKS:/i.test(line)) {
            section = "risks";
            continue;
          }
          if (/^RECOMMENDATIONS:/i.test(line)) {
            section = "recs";
            continue;
          }

          if (!line) continue;

          if (section === "summary") {
            summary.push(rawLine);
          } else if (section === "risks") {
            if (line.startsWith("-")) {
              risks.push(line.replace(/^-+\s*/, ""));
            }
          } else if (section === "recs") {
            if (line.startsWith("-")) {
              recs.push(line.replace(/^-+\s*/, ""));
            }
          }
        }

        return {
          summary: summary.join("\n").trim(),
          risks,
          recs,
        };
      }

      function severityFromLine(line) {
        const m = line.match(/\[(High|Medium|Low)\]/i);
        if (!m) return "medium";
        const s = m[1].toLowerCase();
        if (s.startsWith("high")) return "high";
        if (s.startsWith("low")) return "low";
        return "medium";
      }

      function classifyRisk(cleanText) {
        const tags = [];
        if (
          /—à—Ç—Ä–∞—Ñ|–Ω–µ—É—Å—Ç–æ–π–∫|–ø–µ–Ω–∏|–æ–ø–ª–∞—Ç|—Å—É–º–º|–∫–æ–º–∏—Å—Å–∏|–ø–ª–∞—Ç–µ–∂|–≤–æ–∑–º–µ—â–µ–Ω/i.test(
            cleanText
          )
        )
          tags.push("—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π");
        if (
          /—Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω|–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω|—Å—É–¥|–æ—Å–ø–∞—Ä–∏–≤–∞–Ω|—é—Ä–∏—Å–¥–∏–∫—Ü|–ø—Ä–µ—Ç–µ–Ω–∑–∏/i.test(
            cleanText
          )
        )
          tags.push("—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π");
        if (/–¥–æ—Å—Ç—É–ø|–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω|–¥–∞–Ω–Ω|–∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª|kyc|—Å–∞–Ω–∫—Ü/i.test(cleanText))
          tags.push("–¥–∞–Ω–Ω—ã–µ/KYC");
        if (/—Å—Ä–æ–∫|–¥–µ–¥–ª–∞–π–Ω|—Å—Ä–æ–∫–∏|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏/i.test(cleanText))
          tags.push("—Å—Ä–æ–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
        if (!tags.length) tags.push("–ø—Ä–æ—á–µ–µ");
        return tags;
      }

      function riskTagIcon(tags) {
        if (tags.includes("—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π")) return "üí∞";
        if (tags.includes("—é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π")) return "‚öñÔ∏è";
        if (tags.includes("–¥–∞–Ω–Ω—ã–µ/KYC")) return "üîí";
        if (tags.includes("—Å—Ä–æ–∫–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")) return "‚è∞";
        return "üîé";
      }

      function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      }

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —è–∫–æ—Ä—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      function buildHighlightedHtml(contractText, topHighRisks) {
        if (!contractText.trim()) {
            return "–ó–¥–µ—Å—å –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∞–º—ã—Ö –æ–ø–∞—Å–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.";
        }

        let html = contractText;
        riskCounter = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –∞–Ω–∞–ª–∏–∑–µ

        if (topHighRisks && topHighRisks.length > 0) {
            topHighRisks.forEach((risk) => {
                let baseText = risk.cleanText || "";
                if (!baseText) return;
                baseText = baseText.replace(/\[(High|Medium|Low)\]/gi, "").trim();
                if (baseText.length > 80) baseText = baseText.slice(0, 80);
                if (baseText.length < 10) return;

                const pattern = escapeRegExp(baseText.slice(0, 40));
                const re = new RegExp(pattern, "gi");
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —è–∫–æ—Ä—å —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
                html = html.replace(re, (m) => {
                    const currentId = `risk-${riskCounter++}`;
                    return `<span id="${currentId}" class="hl-high">${m}</span>`; 
                });
            });
        }

        html = html.replace(/\r\n/g, "\n").replace(/\n/g, "<br>");
        return html;
      }

      // –õ–û–ì–ò–ö–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –ü–û–ò–°–ö–ê
      function applyFilters() {
          const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
          const searchTerm = searchRisksInput.value.toLowerCase().trim();
          
          allRiskItems.forEach(li => {
              const severity = li.getAttribute('data-severity');
              const text = li.textContent.toLowerCase();
              
              let matchesFilter = (activeFilter === 'all' || severity === activeFilter);
              let matchesSearch = (searchTerm === '' || text.includes(searchTerm));
              
              if (matchesFilter && matchesSearch) {
                  li.classList.remove('hidden');
              } else {
                  li.classList.add('hidden');
              }
          });
      }

      // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: renderStructuredReport
      function renderStructuredReport(report) {
        lastReportText = report;
        allRiskItems = []; 

        // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
        filterCountAllEl.textContent = '0';
        filterCountHighEl.textContent = '0';
        filterCountMediumEl.textContent = '0';
        filterCountLowEl.textContent = '0';

        if (!report.trim()) {
            summaryTextEl.textContent =
                "–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.";
            risksListEl.innerHTML = "";
            recsListEl.innerHTML = "";
            topRisksRowEl.innerHTML = "";
            neuroAdviceTextEl.textContent =
                "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.";
            scoreValueEl.textContent = "0";
            setHeroCircle(0);
            scoreLevelTextEl.textContent = levelText("Low");
            scoreDescEl.textContent =
                "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ü–µ–Ω–∫—É —Ç–æ–∫—Å–∏—á–Ω–æ—Å—Ç–∏ –¥–æ–≥–æ–≤–æ—Ä–∞.";
            updateRiskPill(0, "Low");
            updateRiskDistribution(0, 0, 0); 
            verdictTextEl.textContent =
                "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–∫–∏ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–µ—Ä–¥–∏–∫—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É.";
            verdictTextEl.classList.remove(
                "verdict-low",
                "verdict-medium",
                "verdict-high"
            );
            verdictTextEl.classList.add("verdict-low");
            highlightBox.innerHTML =
                "–ó–¥–µ—Å—å –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∞–º—ã—Ö –æ–ø–∞—Å–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.";
            return;
        }

        const { score, level } = parseScoreAndLevel(report);
        scoreValueEl.textContent = String(score);
        setHeroCircle(score);
        scoreLevelTextEl.textContent = levelText(level);
        scoreDescEl.textContent = levelDesc(level);
        updateRiskPill(score, level);
        updateVerdict(score);

        const { summary, risks, recs } = parseReportSections(report);

        summaryTextEl.textContent =
            summary || "–ò–ò –Ω–µ –≤–µ—Ä–Ω—É–ª –∫—Ä–∞—Ç–∫–æ–≥–æ —Ä–µ–∑—é–º–µ –ø–æ —ç—Ç–æ–º—É –¥–æ–≥–æ–≤–æ—Ä—É.";

        // --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–∏—Å–∫–æ–≤ ---
        risksListEl.innerHTML = "";
        topRisksRowEl.innerHTML = "";

        const riskObjects = risks.map((riskLine) => {
            const sev = severityFromLine(riskLine);
            const cleanText = riskLine.replace(/\s*\[(High|Medium|Low)\]\s*/i, "");
            const tags = classifyRisk(cleanText);
            return { line: riskLine, severity: sev, cleanText, tags };
        });

        const highCount = riskObjects.filter((r) => r.severity === "high").length;
        const medCount = riskObjects.filter((r) => r.severity === "medium").length;
        const lowCount = riskObjects.filter((r) => r.severity === "low").length;
        updateRiskDistribution(highCount, medCount, lowCount);

        const topHighRisks = riskObjects.filter((r) => r.severity === "high").slice(0, 3);
        
        // –í–ù–ò–ú–ê–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É, —á—Ç–æ–±—ã `riskCounter` –æ–±–Ω–æ–≤–∏–ª—Å—è
        highlightBox.innerHTML = buildHighlightedHtml(lastContractText, topHighRisks);
        let currentRiskIndex = 0; // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —è–∫–æ—Ä—è–º

        if (topHighRisks.length === 0) {
            topRisksRowEl.innerHTML =
                '<div class="small-label">–í—ã—Å–æ–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ.</div>';
        } else {
            topRisksRowEl.innerHTML = '';
            topHighRisks.forEach((risk) => {
                const card = document.createElement("div");
                card.className = "top-risk-card";

                const header = document.createElement("div");
                header.className = "top-risk-header";
                const left = document.createElement("div");
                left.textContent = "‚ö†Ô∏è High-risk";
                const hint = document.createElement("div");
                hint.className = "small-label";
                hint.textContent = "–ö–ª—é—á–µ–≤–æ–π —Ä–∏—Å–∫ –ø–æ –º–Ω–µ–Ω–∏—é –ò–ò";
                header.appendChild(left);
                header.appendChild(hint);

                const title = document.createElement("div");
                title.className = "top-risk-title";
                title.textContent = risk.cleanText;

                const body = document.createElement("div");
                body.className = "top-risk-caption";
                body.textContent =
                    "–≠—Ç–æ –æ–¥–∏–Ω –∏–∑ –ø—É–Ω–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–µ—Å—Ç–∏ –Ω–∞–∏–±–æ–ª—å—à–∏–π —É—â–µ—Ä–± –ö–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –∏–ª–∏ —Å–ø–æ—Ä–µ.";

                card.appendChild(header);
                card.appendChild(title);
                card.appendChild(body);
                topRisksRowEl.appendChild(card);
            });
        }

        // –ù–µ–π—Ä–æ—Å–æ–≤–µ—Ç
        if (riskObjects.length === 0) {
            neuroAdviceTextEl.textContent =
                "–ò–ò –Ω–µ –≤—ã–¥–µ–ª–∏–ª —è–≤–Ω—ã—Ö —Ä–∏—Å–∫–æ–≤. –ü—Ä–∏ –∫—Ä—É–ø–Ω—ã—Ö —Å—É–º–º–∞—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç–æ–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä —é—Ä–∏—Å—Ç—É.";
        } else {
            const mainRisk = topHighRisks[0] || riskObjects[0];
            neuroAdviceTextEl.textContent =
                '–ò–ò —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ –≥–ª–∞–≤–Ω–∞—è —É–≥—Ä–æ–∑–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞: ¬´' +
                mainRisk.cleanText +
                "¬ª. –û–±—Å—É–¥–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—É–Ω–∫—Ç–∞ —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º.";
        }

        // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–∏—Å–∫–æ–≤
        if (riskObjects.length === 0) {
            const li = document.createElement("li");
            li.className = "risk-item low";
            li.innerHTML =
                '<span class="risk-text">–Ø–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ –Ω–µ –±—ã–ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã –≤ –æ—Ç—á—ë—Ç–µ.</span>';
            risksListEl.appendChild(li);
        } else {
            riskObjects.forEach((risk) => {
                const li = document.createElement("li");
                li.className = "risk-item " + risk.severity; 
                li.setAttribute('data-severity', risk.severity); 
                allRiskItems.push(li);

                const headerRow = document.createElement("div");
                headerRow.className = "risk-header-row";

                const badge = document.createElement("span");
                const sev = risk.severity;
                let icon = "üü°";
                let badgeClass = "badge-medium";
                if (sev === "high") {
                    icon = "‚ö†Ô∏è";
                    badgeClass = "badge-high";
                } else if (sev === "low") {
                    icon = "‚úÖ";
                    badgeClass = "badge-low";
                }
                badge.className = "risk-badge " + badgeClass;
                const iconSpan = document.createElement("span");
                iconSpan.textContent = icon;
                const textSpanLev = document.createElement("span");
                textSpanLev.textContent =
                    sev === "high" ? "High" : sev === "medium" ? "Medium" : "Low";
                badge.appendChild(iconSpan);
                badge.appendChild(textSpanLev);

                const textSpan = document.createElement("span");
                textSpan.className = "risk-text";
                textSpan.textContent = risk.cleanText;

                headerRow.appendChild(badge);
                headerRow.appendChild(textSpan);

                const metaRow = document.createElement("div");
                metaRow.className = "risk-meta-row";

                const tagsSpan = document.createElement("span");
                tagsSpan.className = "risk-tags";
                const iconTag = document.createElement("span");
                iconTag.className = "risk-tags-icon";
                iconTag.textContent = riskTagIcon(risk.tags);
                const textTag = document.createElement("span");
                textTag.textContent = risk.tags.join(" ¬∑ ");
                tagsSpan.appendChild(iconTag);
                tagsSpan.appendChild(textTag);

                const rewriteBtn = document.createElement("button");
                rewriteBtn.className = "btn-mini";
                rewriteBtn.innerHTML = "üìù –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∞–≤–∫—É";

                metaRow.appendChild(tagsSpan);
                
                // --- –ö–ù–û–ü–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –ö –Ø–ö–û–†–Æ ---
                const anchorCheck = topHighRisks.some(t => t.cleanText === risk.cleanText);
                const anchorId = anchorCheck && (riskCounter > 0) ? `risk-${currentRiskIndex++}` : null;
                
                if (anchorId) {
                    const navLink = document.createElement('button');
                    navLink.className = 'btn-mini btn-ghost';
                    navLink.textContent = '‚Üë –ü–æ–∫–∞–∑–∞—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ';
                    
                    navLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetElement = document.getElementById(anchorId);
                        const highlightBox = document.getElementById('highlightBox');
                        
                        if (targetElement && highlightBox) {
                            highlightBox.scrollTop = targetElement.offsetTop - highlightBox.offsetTop - 10; 
                            
                            targetElement.style.outline = '2px solid #60a5fa';
                            setTimeout(() => {
                                targetElement.style.outline = 'none';
                            }, 1500);
                        }
                    });
                    metaRow.appendChild(navLink);
                }
                // --- –ö–û–ù–ï–¶ –ö–ù–û–ü–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ---

                metaRow.appendChild(rewriteBtn);

                // –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø DIFF MODE
                const diffContainer = document.createElement("div");
                diffContainer.className = "diff-container";

                li.appendChild(headerRow);
                li.appendChild(metaRow);
                li.appendChild(diffContainer); 
                
                // 3. –õ–æ–≥–∏–∫–∞ Diff Mode
                rewriteBtn.addEventListener("click", async () => {
                    const isAlreadyOpen = li.classList.contains("open-diff");
                    
                    if (isAlreadyOpen) {
                        li.classList.remove("open-diff");
                        diffContainer.style.display = "none";
                        rewriteBtn.innerHTML = "üìù –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø—Ä–∞–≤–∫—É";
                        return;
                    }

                    li.classList.add("open-diff");
                    diffContainer.style.display = "block";
                    
                    if (diffContainer.getAttribute('data-safe-clause')) {
                        rewriteBtn.innerHTML = "‚ùå –°–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–∫—É";
                        return;
                    }
                    
                    rewriteBtn.disabled = true;
                    diffContainer.textContent = "‚öôÔ∏è –ò–ò –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É...";
                    
                    try {
                        const res = await fetch("/rewrite_clause", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ clause: risk.cleanText }),
                        });

                        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–∏");

                        const data = await res.json();
                        const safeClause = (data.safe_clause || "").trim();
                        
                        if (safeClause) {
                            const diffHtml = generateDiffHtml(risk.cleanText, safeClause);

                            diffContainer.innerHTML = `
                                <strong>–û—Ä–∏–≥–∏–Ω–∞–ª:</strong>
                                <div style="margin-bottom: 10px; padding: 4px; border-bottom: 1px dashed #eee;">
                                    <span class="diff-deleted">${risk.cleanText}</span>
                                </div>
                                <strong>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ò–ò:</strong>
                                <div style="margin-bottom: 10px; padding: 4px; border-bottom: 1px dashed #eee;">
                                    ${diffHtml}
                                </div>
                                <div class="diff-controls">
                                    <button class="btn-mini btn-primary" onclick="copyTextToClipboard('${safeClause.replace(/'/g, "\\'")}')">
                                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∞–≤–∫–∏
                                    </button>
                                </div>
                            `;
                            diffContainer.setAttribute('data-safe-clause', safeClause);

                        } else {
                            diffContainer.textContent = "üö´ –ò–ò –Ω–µ —Å–º–æ–≥ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–º–µ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏.";
                        }
                    } catch (e) {
                        console.error(e);
                        diffContainer.textContent = "üî• –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.";
                    } finally {
                        rewriteBtn.innerHTML = "‚ùå –°–∫—Ä—ã—Ç—å –ø—Ä–∞–≤–∫—É";
                        rewriteBtn.disabled = false;
                    }
                });
                
                risksListEl.appendChild(li);
            });
        }
        
        // --- —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ---
        recsListEl.innerHTML = "";
        if (!recs || recs.length === 0) {
            const li = document.createElement("li");
            li.className = "rec-item";
            li.innerHTML =
                '<span class="rec-text">–ò–ò –Ω–µ –¥–∞–ª —è–≤–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –∏–∑–º–µ–Ω–µ–Ω–∏—é –¥–æ–≥–æ–≤–æ—Ä–∞.</span>';
            recsListEl.appendChild(li);
        } else {
            recs.forEach((recLine) => {
                const li = document.createElement("li");
                li.className = "rec-item";

                const badge = document.createElement("span");
                badge.className = "rec-badge";
                badge.innerHTML = "üí°<span>–°–æ–≤–µ—Ç</span>";
                
                // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–π—Å—è —à–∞–±–ª–æ–Ω–Ω–æ–π —Ñ—Ä–∞–∑—ã
                const REC_CLEAN_PATTERN = /(–°–æ–≤–µ—Ç\s*|–ö–∞–∫\s*–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\s*|–û–±—Å—É–¥–∏—Ç–µ —ç—Ç—É –ø—Ä–∞–≤–∫—É —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –≤ –¥–æ–≥–æ–≤–æ—Ä–µ\.\s*–≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ —Å–ø–æ—Ä–Ω—ã—Ö —Ç—Ä–∞–∫—Ç–æ–≤–æ–∫ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π\.\s*)/gi;
                const cleanRec = recLine.replace(REC_CLEAN_PATTERN, '').trim();

                const textSpan = document.createElement("span");
                textSpan.className = "rec-text";
                textSpan.textContent = cleanRec;

                const details = document.createElement("div");
                details.className = "rec-details";
                details.innerHTML =
                    "<strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong> –û–±—Å—É–¥–∏—Ç–µ —ç—Ç—É –ø—Ä–∞–≤–∫—É —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –≤ –¥–æ–≥–æ–≤–æ—Ä–µ. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ —Å–ø–æ—Ä–Ω—ã—Ö —Ç—Ä–∞–∫—Ç–æ–≤–æ–∫ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π.";

                li.appendChild(badge);
                li.appendChild(textSpan);
                li.appendChild(details);

                li.addEventListener("click", () => {
                    li.classList.toggle("open");
                });

                recsListEl.appendChild(li);
            });
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        applyFilters(); 
      }

      function setLoading(isLoading, msg) {
        if (isLoading) {
          statusSpinner.style.display = "block";
          statusText.textContent = msg || "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ–≥–æ–≤–æ—Ä...";
          btnAnalyze.disabled = true;
          analyzeFileBtn.disabled = true;
        } else {
          statusSpinner.style.display = "none";
          statusText.textContent = msg || "";
          btnAnalyze.disabled = false;
        }
      }

      async function callAnalyze(payload) {
        setLoading(true, "–ß–∏—Ç–∞—é –¥–æ–≥–æ–≤–æ—Ä, –∏—â—É —Ä–∏—Å–∫–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...");
        summaryTextEl.textContent = "–ò–¥—ë—Ç –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞...";
        risksListEl.innerHTML = "";
        recsListEl.innerHTML = "";
        topRisksRowEl.innerHTML = "";
        neuroAdviceTextEl.textContent =
          "–ò–¥—ë—Ç –∞–Ω–∞–ª–∏–∑. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞...";
        highlightBox.innerHTML =
          "–°—Ç—Ä–æ–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ä–∏—Å–∫–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É –¥–æ–≥–æ–≤–æ—Ä–∞...";

        try {
          const res = await fetch("/analyze_one", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞");
          }

          const report = await res.text();
          renderStructuredReport(report);
          setLoading(false, "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω");
        } catch (e) {
          console.error(e);
          summaryTextEl.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–æ–≥–æ–≤–æ—Ä–∞.";
          neuroAdviceTextEl.textContent =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.";
          highlightBox.innerHTML =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
          setLoading(false, "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑");
        }
      }

      // –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞
      btnAnalyze.addEventListener("click", () => {
        const text = taInput.value.trim();
        if (!text) {
          alert("–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞");
          return;
        }
        lastContractText = text;
        callAnalyze({
          text: text,
          chunk_chars: 6000,
          max_chunks: 3,
          format: "readable",
        });
      });

      // –≠–∫—Å–ø–æ—Ä—Ç DOCX
      exportBtn.addEventListener("click", async () => {
        const report = lastReportText.trim();
        if (!report) {
          alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑, —á—Ç–æ–±—ã –±—ã–ª–æ —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.");
          return;
        }
        try {
          const res = await fetch("/make_docx", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ report }),
          });
          if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || "–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ DOCX");
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "WorldSimplify_Report.docx";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error(e);
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å DOCX: " + (e.message || e));
        }
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
      uploadBtn.addEventListener("click", async () => {
        const file = fileInput.files[0];
        if (!file) {
          alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
          return;
        }
        await uploadFile(file);
      });

      async function uploadFile(file) {
        const formData = new FormData();
        formData.append("file", file);

        previewBox.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...";
        analyzeFileBtn.disabled = true;
        currentDocId = null;

        try {
          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞");
          }

          const data = await res.json();
          currentDocId = data.doc_id;
          const preview = data.preview_text || "";
          previewBox.textContent = preview || "–ü—Ä–µ–≤—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ";
          lastContractText = data.plain_text || preview || lastContractText;
          analyzeFileBtn.disabled = false;
          statusText.textContent = "–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑.";
        } catch (e) {
          console.error(e);
          previewBox.textContent =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: " + (e.message || e);
        }
      }

      // Drag & drop –¥–ª—è uploadCard
      uploadCard.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadCard.classList.add("dragover");
      });
      uploadCard.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadCard.classList.remove("dragover");
      });
      uploadCard.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadCard.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) {
          fileInput.files = e.dataTransfer.files;
          uploadFile(file);
        }
      });

      // –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞
      analyzeFileBtn.addEventListener("click", async () => {
        if (!currentDocId) {
          alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª");
          return;
        }

        setLoading(true, "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª...");
        summaryTextEl.textContent = "–ò–¥—ë—Ç –∞–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞...";
        topRisksRowEl.innerHTML = "";
        neuroAdviceTextEl.textContent =
          "–ò–¥—ë—Ç –∞–Ω–∞–ª–∏–∑. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞...";
        highlightBox.innerHTML =
          "–°—Ç—Ä–æ–∏–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ä–∏—Å–∫–æ–≤ –ø–æ —Ç–µ–∫—Å—Ç—É –¥–æ–≥–æ–≤–æ—Ä–∞...";

        try {
          const res = await fetch("/analyze_by_doc_id", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              doc_id: currentDocId,
              chunk_chars: 6000,
              max_chunks: 3,
              format: "readable",
            }),
          });

          if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞");
          }

          const report = await res.text();
          try {
            const parsedRes = await fetch(`/parsed/${currentDocId}`);
            if (parsedRes.ok) {
              const parsedJson = await parsedRes.json();
              lastContractText = parsedJson.plain_text || lastContractText;
            }
          } catch (e) {
            console.warn("parsed fetch error", e);
          }
          renderStructuredReport(report);
          setLoading(false, "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω");
        } catch (e) {
          console.error(e);
          summaryTextEl.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–∞–π–ª–∞.";
          neuroAdviceTextEl.textContent =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.";
          highlightBox.innerHTML =
            "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥—Å–≤–µ—Ç–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
          setLoading(false, "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑");
        }
      });

      // –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ (Summary / Top / Risks / Recs / Hero / Neuro)
      document.querySelectorAll(".card-toggle").forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const targetId = toggle.getAttribute("data-target");
          if (!targetId) return;
          const body = document.getElementById(targetId);
          if (!body) return;
          const card = toggle.closest(".result-card");
          const isCollapsed = card.classList.toggle("card-collapsed");
          toggle.textContent = (isCollapsed ? "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" : "–°–≤–µ—Ä–Ω—É—Ç—å") + " ‚åÑ";
        });
      });
      
      // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò –ò –ü–û–ò–°–ö–ê
      document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
              document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
              e.currentTarget.classList.add('active');
              applyFilters();
          });
      });

      searchRisksInput.addEventListener('input', applyFilters);
      
      // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è Diff Mode –∏ UI ---
      
      // –ü—Ä–æ—Å—Ç–∞—è —ç–º—É–ª—è—Ü–∏—è Diff 
      function generateDiffHtml(original, safe) {
          if (original === safe) {
              return safe + ' <span class="diff-added">(–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞)</span>';
          }
          return `<span class="diff-added">${safe}</span>`;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –±—É—Ñ–µ—Ä
      function copyTextToClipboard(text) {
          const plainText = text.replace(/<[^>]*>?/gm, ''); 
          navigator.clipboard.writeText(plainText).then(() => {
              alert("–¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
          }).catch(err => {
              console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ', err);
              alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.");
          });
      }
      
    </script>
  </body>
</html>